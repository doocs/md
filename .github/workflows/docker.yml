name: Build and Push Docker Images

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  # é»˜è®¤çš„Docker Hubç»„ç»‡/ç”¨æˆ·å
  # forkä»“åº“å¯ä»¥é€šè¿‡è®¾ç½®DOCKER_REGISTRY_USER secretæ¥è¦†ç›–
  DEFAULT_DOCKER_USER: doocs
  # é»˜è®¤çš„é•œåƒåç§°
  DEFAULT_IMAGE_NAME: md

jobs:
  build:
    runs-on: ubuntu-latest
    # åªæœ‰åœ¨æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ä¹‹ä¸€æ—¶æ‰æ‰§è¡Œï¼š
    # 1. æ˜¯å®˜æ–¹ä»“åº“ (doocs/md)
    # 2. forkä»“åº“è®¾ç½®äº†DOCKER_REGISTRY_USER secret
    if: |
      github.repository == 'doocs/md' || 
      (github.repository != 'doocs/md' && 
       github.event.repository.private == false &&
       vars.ENABLE_DOCKER_BUILD == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    # åŠ¨æ€è®¾ç½®Dockeré…ç½®
    - name: Set Docker configuration
      id: docker-config
      run: |
        if [ "${{ github.repository }}" = "doocs/md" ]; then
          # å®˜æ–¹ä»“åº“ä½¿ç”¨é»˜è®¤é…ç½®
          echo "registry_user=${{ env.DEFAULT_DOCKER_USER }}" >> $GITHUB_OUTPUT
          echo "image_name=${{ env.DEFAULT_IMAGE_NAME }}" >> $GITHUB_OUTPUT
          echo "image_tag=doocs/md" >> $GITHUB_OUTPUT
        else
          # forkä»“åº“ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
          REPO_OWNER=$(echo "${{ github.repository }}" | cut -d'/' -f1)
          echo "registry_user=${DOCKER_REGISTRY_USER:-$REPO_OWNER}" >> $GITHUB_OUTPUT
          echo "image_name=${DOCKER_IMAGE_NAME:-${{ env.DEFAULT_IMAGE_NAME }}}" >> $GITHUB_OUTPUT
          echo "image_tag=${DOCKER_REGISTRY_USER:-$REPO_OWNER}/${DOCKER_IMAGE_NAME:-${{ env.DEFAULT_IMAGE_NAME }}}" >> $GITHUB_OUTPUT
        fi
      env:
        DOCKER_REGISTRY_USER: ${{ vars.DOCKER_REGISTRY_USER }}
        DOCKER_IMAGE_NAME: ${{ vars.DOCKER_IMAGE_NAME }}

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # æ ¹æ®ä»“åº“ç±»å‹é€‰æ‹©ä¸åŒçš„å‡­æ®
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ github.repository == 'doocs/md' && secrets.DOCKER_USERNAME || vars.DOCKER_REGISTRY_USER }}
        password: ${{ github.repository == 'doocs/md' && secrets.DOCKER_PASSWORD || secrets.DOCKER_REGISTRY_TOKEN }}

    # æ„å»ºå¤šæ¶æ„é•œåƒï¼Œæ”¯æŒè‡ªå®šä¹‰æ ‡ç­¾
    - name: Build and push multi-arch images
      run: |
        # è®¾ç½®ç¯å¢ƒå˜é‡ä¾›æ„å»ºè„šæœ¬ä½¿ç”¨
        export DOCKER_IMAGE_TAG="${{ steps.docker-config.outputs.image_tag }}"
        export DOCKER_REGISTRY_USER="${{ steps.docker-config.outputs.registry_user }}"
        export DOCKER_IMAGE_NAME="${{ steps.docker-config.outputs.image_name }}"
        
        chmod +x scripts/build-multiarch.sh
        bash scripts/build-multiarch.sh

    # è¾“å‡ºæ„å»ºä¿¡æ¯
    - name: Output build information
      run: |
        echo "âœ… Successfully built and pushed Docker image:"
        echo "ğŸ·ï¸  Image: ${{ steps.docker-config.outputs.image_tag }}"
        echo "ğŸ¢ Registry User: ${{ steps.docker-config.outputs.registry_user }}"
        echo "ğŸ“¦ Repository: ${{ github.repository }}"
        echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
